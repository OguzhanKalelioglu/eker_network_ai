<!doctype html>
<html lang="tr">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Loglar - Network Error AI</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-bg: #f8fafc;
            --secondary-bg: #ffffff;
            --card-bg: #ffffff;
            --accent-blue: #0ea5e9;
            --accent-green: #10b981;
            --accent-orange: #f59e0b;
            --accent-red: #ef4444;
            --accent-purple: #8b5cf6;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --border: #e2e8f0;
            --border-focus: #0ea5e9;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        .app-container { display: flex; min-height: 100vh; }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--secondary-bg);
            border-right: 1px solid var(--border);
            box-shadow: var(--shadow-lg);
            display: flex; flex-direction: column;
            position: sticky; top: 0; height: 100vh;
            transition: transform 0.3s ease;
        }

        .sidebar.collapsed {
            transform: translateX(-100%);
        }

        .sidebar-toggle {
            display: block;
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 1001;
            background: var(--accent-blue);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0.75rem;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            transition: all 0.2s ease;
        }

        .sidebar-toggle:hover {
            background: #0284c7;
            transform: scale(1.05);
        }

        /* Desktop'ta sidebar toggle'ƒ± gizle */
        @media (min-width: 769px) {
            .sidebar-toggle {
                display: none;
            }
        }

        .sidebar-header { padding: 1.5rem; border-bottom: 1px solid var(--border); }

        .logo {
            display: flex; align-items: center; gap: 0.75rem;
            font-size: 1.25rem; font-weight: 700; color: var(--text-primary);
        }

        .logo-icon {
            width: 40px; height: 40px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            border-radius: 10px; display: flex; align-items: center; justify-content: center;
            color: white; font-size: 1.2rem;
        }

        .sidebar-nav { flex: 1; padding: 1rem 0; }
        .nav-item { margin: 0.25rem 1rem; }

        .nav-link {
            display: flex; align-items: center; gap: 0.75rem;
            padding: 0.75rem 1rem; color: var(--text-secondary); text-decoration: none;
            border-radius: 8px; font-weight: 500; transition: all 0.2s ease; cursor: pointer;
        }

        .nav-link:hover { background: var(--card-bg); color: var(--text-primary); }
        .nav-link.active { background: var(--accent-blue); color: white; }

        .nav-icon { width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; }

        .sidebar-footer {
            padding: 1rem; border-top: 1px solid var(--border); background: #f1f5f9;
        }

        .status-indicator {
            display: flex; align-items: center; gap: 0.5rem;
            font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.75rem;
        }

        .status-dot {
            width: 8px; height: 8px; border-radius: 50%;
            background: var(--accent-green); animation: pulse 2s infinite;
        }

        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        /* Main Content */
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

        .main-header {
            background: var(--secondary-bg); border-bottom: 1px solid var(--border);
            padding: 1rem 2rem; display: flex; align-items: center; justify-content: space-between;
            box-shadow: var(--shadow);
        }

        .page-title {
            font-size: 1.5rem; font-weight: 600; color: var(--text-primary);
            display: flex; align-items: center; gap: 0.5rem;
        }

        .main-body { flex: 1; padding: 2rem; overflow-y: auto; background: var(--primary-bg); }

        /* Page specific styles */
        .stats-panel { background: var(--card-bg); border: 1px solid var(--border); border-radius: 1rem; padding: 1.5rem; margin-bottom: 2rem; box-shadow: var(--shadow); }
        .stats-title { font-size: 1.2rem; font-weight: 600; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; }
        .stat-card { background: var(--secondary-bg); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1.25rem; text-align: center; transition: all 0.2s ease; }
        .stat-card:hover { transform: translateY(-2px); border-color: var(--border-focus); }
        .stat-value { font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem; }
        .stat-label { font-size: 0.875rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; }
        .stat-card.emails .stat-value { color: var(--accent-blue); }
        .stat-card.incidents .stat-value { color: var(--accent-green); }
        .stat-card.tools .stat-value { color: var(--accent-purple); }
        .stat-card.regions .stat-value { color: var(--accent-orange); }
        .stat-card.failed .stat-value { color: var(--accent-red); }

        .toolbar { background: var(--card-bg); border: 1px solid var(--border); border-radius: 1rem; padding: 1.5rem; margin-bottom: 2rem; box-shadow: var(--shadow); display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; }
        .filter-group { display: flex; align-items: center; gap: 0.5rem; flex: 1; min-width: 200px; }
        .filter-label { font-size: 0.875rem; font-weight: 500; color: var(--text-secondary); white-space: nowrap; }
        .filter-select { padding: 0.5rem 0.75rem; background: var(--secondary-bg); border: 1px solid var(--border); border-radius: 0.5rem; color: var(--text-primary); font-size: 0.875rem; min-width: 120px; }
        .search-input { flex: 1; min-width: 250px; padding: 0.75rem 1rem; background: var(--secondary-bg); border: 1px solid var(--border); border-radius: 0.5rem; color: var(--text-primary); font-size: 0.875rem; }
        .search-input:focus { outline: none; border-color: var(--border-focus); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .controls { display: flex; gap: 0.75rem; align-items: center; }

        .btn { padding: 0.75rem 1rem; border: none; border-radius: 0.5rem; font-size: 0.875rem; font-weight: 500; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 0.5rem; }
        .btn-primary { background: var(--accent-blue); color: white; }
        .btn-primary:hover { background: #2563eb; transform: translateY(-1px); }
        .btn-secondary { background: var(--secondary-bg); color: var(--text-secondary); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--card-bg); color: var(--text-primary); }
        .btn-danger { background: var(--accent-red); color: white; }
        .btn-danger:hover { background: #dc2626; }

        .logs-grid { display: grid; gap: 1rem; grid-template-columns: 1fr; }
        .log-card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1.25rem; box-shadow: var(--shadow); transition: all 0.2s ease; position: relative; max-width: 900px; margin: 0 auto; width: 100%; }
        .log-card:hover { border-color: var(--border-focus); transform: translateY(-2px); }
        .log-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid var(--border); }
        .log-type { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
        .log-type.received { background: var(--accent-blue); color: white; }
        .log-type.sent_incident { background: var(--accent-green); color: white; }
        .log-type.non_incident { background: var(--text-muted); color: white; }
        .log-type.processing { background: var(--accent-purple); color: white; }
        .log-type.retry { background: var(--accent-orange); color: white; }
        .log-type.failed { background: var(--accent-red); color: white; }
        .log-time { font-size: 0.75rem; color: var(--text-muted); display: flex; align-items: center; gap: 0.25rem; }
        .log-content { margin-bottom: 1rem; }
        .log-title { font-size: 1rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem; word-break: break-word; }
        .log-details { font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.75rem; line-height: 1.5; }
        .tool-calls-section { background: var(--secondary-bg); border: 1px solid var(--border); border-radius: 0.5rem; padding: 0.75rem; margin: 0.75rem 0; }
        .tool-call-item { display: flex; align-items: center; gap: 0.5rem; padding: 0.25rem 0; font-size: 0.8rem; color: var(--text-secondary); }
        .tool-call-item i { color: var(--accent-purple); }
        .body-preview { background: var(--secondary-bg); border-left: 3px solid var(--accent-blue); padding: 0.75rem; border-radius: 0.25rem; margin: 0.75rem 0; font-size: 0.8rem; color: var(--text-secondary); font-style: italic; }
        .log-footer { display: flex; gap: 1rem; font-size: 0.75rem; color: var(--text-muted); flex-wrap: wrap; }
        .log-footer-item { display: flex; align-items: center; gap: 0.25rem; }
        .empty-state { text-align: center; padding: 3rem; color: var(--text-muted); grid-column: 1 / -1; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 300px; }
        .empty-state i { font-size: 3rem; margin-bottom: 1rem; opacity: 0.5; }
        .regions-list { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem; }
        .region-badge { background: var(--secondary-bg); border: 1px solid var(--border); padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; }
        .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .loading-overlay.active { display: flex; }
        .spinner { width: 50px; height: 50px; border: 3px solid var(--border); border-top: 3px solid var(--accent-blue); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                z-index: 1000;
                transform: translateX(-100%);
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .sidebar-toggle {
                display: block;
            }
            
            .main-content {
                width: 100%;
                margin-left: 0;
            }
            
            .main-header { padding: 1rem; padding-left: 4rem; }
            .main-body { padding: 1rem; }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loading-overlay">
        <div class="spinner"></div>
    </div>

    <!-- Sidebar Toggle Button (Mobile) -->
    <button class="sidebar-toggle" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>

    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-robot"></i>
                    </div>
                    <span>Network AI</span>
                </div>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-item">
                    <a class="nav-link active" href="/admin/logs">
                        <div class="nav-icon"><i class="fas fa-chart-line"></i></div>
                        <span>Loglar</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a class="nav-link" href="/admin/instructions">
                        <div class="nav-icon"><i class="fas fa-brain"></i></div>
                        <span>Talimatlar</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a class="nav-link" href="/admin/emails">
                        <div class="nav-icon"><i class="fas fa-envelope"></i></div>
                        <span>E-posta Ayarlarƒ±</span>
                    </a>
                </div>
            </nav>

            <div class="sidebar-footer">
                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <span>Sistem Aktif</span>
                </div>
                <a class="nav-link" href="/logout">
                    <div class="nav-icon"><i class="fas fa-sign-out-alt"></i></div>
                    <span>√áƒ±kƒ±≈ü Yap</span>
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="main-content">
            <div class="main-header">
                <h1 class="page-title">
                    <i class="fas fa-chart-line"></i>
                    <span>Olay G√ºnl√ºƒü√º</span>
                </h1>
            </div>

            <div class="main-body">
                <div class="stats-panel" id="stats-panel">
                    <div class="stats-title">
                        <i class="fas fa-chart-bar"></i>
                        Son 24 Saat ƒ∞statistikleri
                    </div>
                    <div class="stats-grid" id="stats-grid">
                        <div class="stat-card emails">
                            <div class="stat-value" id="stat-emails">0</div>
                            <div class="stat-label">Toplam E-posta</div>
                        </div>
                        <div class="stat-card incidents">
                            <div class="stat-value" id="stat-incidents">0</div>
                            <div class="stat-label">Arƒ±za Bildirimi</div>
                        </div>
                        <div class="stat-card tools">
                            <div class="stat-value" id="stat-tools">0</div>
                            <div class="stat-label">Fonksiyon √áaƒürƒ±sƒ±</div>
                        </div>
                        <div class="stat-card regions">
                            <div class="stat-value" id="stat-regions">0</div>
                            <div class="stat-label">Bulunan B√∂lge</div>
                            <div class="regions-list" id="regions-list"></div>
                        </div>
                        <div class="stat-card failed">
                            <div class="stat-value" id="stat-failed">0</div>
                            <div class="stat-label">Ba≈üarƒ±sƒ±z ƒ∞≈ülem</div>
                        </div>
                    </div>
                </div>

                <div class="toolbar">
                    <div class="filter-group">
                        <span class="filter-label">
                            <i class="fas fa-filter"></i>
                            T√ºr:
                        </span>
                        <select id="type-filter" class="filter-select">
                            <option value="">T√ºm√º</option>
                            <option value="received">üìß Gelen E-posta</option>
                            <option value="non_incident">‚ÑπÔ∏è Arƒ±za Deƒüil</option>
                            <option value="sent_incident">‚úÖ Arƒ±za Bildirimi</option>
                            <option value="tool_call">üîß Fonksiyon √áaƒürƒ±sƒ±</option>
                            <option value="tool_result">üìç B√∂lge Bilgisi</option>
                            <option value="processing">‚öôÔ∏è ƒ∞≈üleniyor</option>
                            <option value="retry">üîÑ Tekrar Deneme</option>
                            <option value="failed">‚ùå Ba≈üarƒ±sƒ±z</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <span class="filter-label">
                            <i class="fas fa-search"></i>
                            Ara:
                        </span>
                        <input type="text" id="search-input" class="search-input" placeholder="Konu, g√∂nderen veya b√∂lge ara...">
                    </div>

                <div class="controls">
                    <button class="btn btn-primary" onclick="refreshAll()">
                        <i class="fas fa-sync-alt"></i>
                        Yenile
                    </button>
                    <button class="btn btn-danger" onclick="resetLogs()">
                        <i class="fas fa-trash"></i>
                        Loglarƒ± Sƒ±fƒ±rla
                    </button>
                </div>
                </div>

                <div id="logs-container" class="logs-grid">
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <h3>G√ºnl√ºk bo≈ü</h3>
                        <p>Hen√ºz hi√ß olay kaydedilmemi≈ü. Yeni e-postalar geldik√ße burada g√∂r√ºnecek.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let logs = [];
        let filteredLogs = [];
        let stats = {};

        const LOG_TYPES = {
            'received': { icon: 'fa-envelope', color: 'blue', label: 'üìß Gelen E-posta' },
            'sent_incident': { icon: 'fa-check-circle', color: 'green', label: '‚úÖ Arƒ±za Bildirimi G√∂nderildi' },
            'non_incident': { icon: 'fa-info-circle', color: 'gray', label: '‚ÑπÔ∏è Arƒ±za Deƒüil' },
            'processing': { icon: 'fa-cog', color: 'purple', label: '‚öôÔ∏è ƒ∞≈üleniyor' },
            'tool_call': { icon: 'fa-wrench', color: 'purple', label: 'üîß Fonksiyon √áaƒürƒ±sƒ±' },
            'tool_result': { icon: 'fa-map-marker', color: 'blue', label: 'üìç B√∂lge Bilgisi' },
            'retry': { icon: 'fa-redo', color: 'orange', label: 'üîÑ Tekrar Deneme' },
            'failed': { icon: 'fa-times-circle', color: 'red', label: '‚ùå Ba≈üarƒ±sƒ±z' },
            'enqueued': { icon: 'fa-inbox', color: 'purple', label: 'üì• Kuyruƒüa Alƒ±ndƒ±' }
        };

        async function fetchLogs() {
            try {
                const response = await fetch('/logs?offset=0&limit=100');
                const data = await response.json();
                return data.items || [];
            } catch (error) {
                console.error('Failed to fetch logs:', error);
                return [];
            }
        }

        async function fetchStats() {
            try {
                const response = await fetch('/logs/stats');
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Failed to fetch stats:', error);
                return {};
            }
        }

        function updateStats(statsData) {
            document.getElementById('stat-emails').textContent = statsData.total_emails || 0;
            document.getElementById('stat-incidents').textContent = statsData.incident_reports || 0;
            document.getElementById('stat-tools').textContent = statsData.tool_calls || 0;
            document.getElementById('stat-regions').textContent = statsData.unique_regions || 0;
            document.getElementById('stat-failed').textContent = statsData.failed || 0;

            const regionsList = document.getElementById('regions-list');
            if (statsData.regions_found && statsData.regions_found.length > 0) {
                regionsList.innerHTML = statsData.regions_found.map(region => 
                    `<span class="region-badge">${escapeHtml(region)}</span>`
                ).join('');
            } else {
                regionsList.innerHTML = '';
            }
        }

        function formatTime(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp * 1000);
            const now = new Date();
            if (date.toDateString() === now.toDateString()) {
                return `Bug√ºn ${date.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })}`;
            }
            const yesterday = new Date(now);
            yesterday.setDate(yesterday.getDate() - 1);
            if (date.toDateString() === yesterday.toDateString()) {
                return `D√ºn ${date.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })}`;
            }
            return date.toLocaleString('tr-TR', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' });
        }

        function renderLogs() {
            const container = document.getElementById('logs-container');
            const typeFilter = document.getElementById('type-filter').value;
            const searchQuery = document.getElementById('search-input').value.toLowerCase();

            filteredLogs = logs.filter(log => {
                const matchesType = !typeFilter || log.type === typeFilter;
                const matchesSearch = !searchQuery ||
                    (log.subject || '').toLowerCase().includes(searchQuery) ||
                    (log.details || '').toLowerCase().includes(searchQuery) ||
                    (log.from || '').toLowerCase().includes(searchQuery) ||
                    (log.to || '').toLowerCase().includes(searchQuery);
                
                if (!matchesSearch && log.tool_calls && log.tool_calls.length > 0) {
                    const toolMatch = log.tool_calls.some(tc => 
                        JSON.stringify(tc).toLowerCase().includes(searchQuery)
                    );
                    return matchesType && toolMatch;
                }
                
                return matchesType && matchesSearch;
            });

            if (filteredLogs.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-search"></i>
                        <h3>Sonu√ß bulunamadƒ±</h3>
                        <p>Arama kriterlerinize uygun kayƒ±t bulunamadƒ±.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredLogs.map(log => {
                const config = LOG_TYPES[log.type] || { icon: 'fa-circle', color: 'gray', label: log.type };
                const timeStr = formatTime(log.ts);

                let toolCallsHtml = '';
                if (log.tool_calls && log.tool_calls.length > 0) {
                    const toolItems = log.tool_calls.map(tc => {
                        if (tc.type === 'call') {
                            const args = tc.args ? JSON.stringify(tc.args, null, 2) : 'null';
                            return `<div class="tool-call-item"><i class="fas fa-wrench"></i><span>√áaƒürƒ±: ${tc.tool} - ${escapeHtml(args.substring(0, 100))}</span></div>`;
                        } else if (tc.type === 'result' && tc.result) {
                            return `<div class="tool-call-item"><i class="fas fa-check"></i><span>Sonu√ß: ${tc.result.bolge || 'Bilinmiyor'} (${tc.result.sehir || ''})</span></div>`;
                        }
                        return '';
                    }).join('');
                    
                    if (toolItems) {
                        toolCallsHtml = `<div class="tool-calls-section"><strong>üîß Fonksiyon √áaƒürƒ±larƒ±:</strong>${toolItems}</div>`;
                    }
                }

                let bodyPreviewHtml = '';
                if (log.body_preview) {
                    bodyPreviewHtml = `<div class="body-preview">${escapeHtml(log.body_preview)}...</div>`;
                }

                let tagsHtml = '';
                if (log.tags && log.tags.length > 0) {
                    tagsHtml = `<div style="display: flex; gap: 0.5rem; margin-bottom: 0.75rem; flex-wrap: wrap;">${log.tags.map(tag => {
                        let tagClass = 'region-badge';
                        if (tag.includes('ARIZA DEƒûƒ∞L')) tagClass += ' non_incident';
                        else if (tag.includes('ARIZA Bƒ∞LDƒ∞Rƒ∞Mƒ∞')) tagClass += ' sent_incident';
                        else if (tag.includes('BA≈ûARISIZ')) tagClass += ' failed';
                        return `<span class="${tagClass}" style="font-weight: 600;">${escapeHtml(tag)}</span>`;
                    }).join('')}</div>`;
                }
                
                let progressionHtml = '';
                if (log.progression && log.progression.length > 0) {
                    progressionHtml = `<div style="background: var(--secondary-bg); border-left: 3px solid var(--accent-blue); padding: 0.5rem 0.75rem; border-radius: 0.25rem; margin: 0.75rem 0;"><strong style="font-size: 0.75rem; color: var(--text-secondary);">ƒ∞LERLEME:</strong><div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.25rem;">${log.progression.map(step => `‚Ä¢ ${escapeHtml(step)}`).join('<br>')}</div></div>`;
                }

                return `
                    <div class="log-card">
                        <div class="log-header">
                            <div class="log-type ${log.type}">${config.label}</div>
                            <div class="log-time"><i class="fas fa-clock"></i>${timeStr}</div>
                        </div>
                        <div class="log-content">
                            ${tagsHtml}
                            ${log.subject ? `<div class="log-title">${escapeHtml(log.subject)}</div>` : ''}
                            ${log.details ? `<div class="log-details" style="white-space: pre-line;">${escapeHtml(log.details)}</div>` : ''}
                            ${progressionHtml}
                            ${toolCallsHtml}
                            ${bodyPreviewHtml}
                            ${log.error ? `<div class="log-details" style="color: var(--accent-red); white-space: pre-line;">‚ö†Ô∏è ${escapeHtml(log.error)}</div>` : ''}
                        </div>
                        <div class="log-footer">
                            ${log.from ? `<div class="log-footer-item"><i class="fas fa-user"></i><span>${escapeHtml(log.from)}</span></div>` : ''}
                            ${log.to ? `<div class="log-footer-item"><i class="fas fa-arrow-right"></i><span>Kime: ${escapeHtml(log.to)}</span></div>` : ''}
                            ${log.threadId ? `<div class="log-footer-item"><i class="fas fa-link"></i><span>Thread: ${log.threadId.substring(0, 8)}...</span></div>` : ''}
                            ${log.job_id ? `<div class="log-footer-item"><i class="fas fa-hashtag"></i><span>Job #${log.job_id}</span></div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        async function resetLogs() {
            if (!confirm('Bu i≈ülem SADECE log kayƒ±tlarƒ±nƒ± temizler.\n\n- E-posta ayarlarƒ± korunacak\n- AI talimatlarƒ± korunacak\n- Sadece log dosyasƒ± temizlenecek\n\nDevam etmek istiyor musunuz?')) {
                return;
            }

            if (!confirm('Emin misiniz? Yalnƒ±zca loglar temizlenecek.')) {
                return;
            }

            try {
                const response = await fetch('/admin/logs/reset', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();

                if (result.status === 'ok') {
                    logs = [];
                    filteredLogs = [];
                    renderLogs();
                    updateStats({});
                    alert('Log kayƒ±tlarƒ± ba≈üarƒ±yla temizlendi.');
                } else {
                    throw new Error(result.message || 'Loglar temizlenemedi');
                }
            } catch (error) {
                alert('Loglar temizlenirken hata olu≈ütu: ' + error.message);
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('open');
        }

        async function refreshAll() {
            const overlay = document.getElementById('loading-overlay');
            overlay.classList.add('active');
            try {
                const [logsData, statsData] = await Promise.all([fetchLogs(), fetchStats()]);
                logs = logsData;
                stats = statsData;
                updateStats(stats);
                renderLogs();
            } catch (error) {
                console.error('Refresh failed:', error);
            } finally {
                overlay.classList.remove('active');
            }
        }

        document.getElementById('type-filter').addEventListener('change', renderLogs);
        document.getElementById('search-input').addEventListener('input', renderLogs);

        document.addEventListener('DOMContentLoaded', function() {
            refreshAll();
            setInterval(refreshAll, 10000);
            document.addEventListener('keydown', function(e) {
                if (e.key === 'r' && (e.ctrlKey || e.metaKey)) {
                    e.preventDefault();
                    refreshAll();
                }
                if (e.key === 'f' && (e.ctrlKey || e.metaKey)) {
                    e.preventDefault();
                    document.getElementById('search-input').focus();
                }
            });
        });
    </script>
</body>
</html>
